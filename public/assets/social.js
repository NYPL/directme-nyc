function social(){var m=window.location.protocol+"//"+window.location.host;var e=window.location;function f(){d();l();g()}function d(){$("#fb-submit").off("click").on("click",function(o){o.preventDefault();c("facebook");o.stopPropagation()})}function l(){$("#tw-submit").off("click").on("click",function(o){o.preventDefault();c("twitter");o.stopPropagation()})}function g(){$("#g-submit").off("click").on("click",function(o){o.preventDefault();c("google_oauth2");o.stopPropagation()})}function n(){$("a.logout").off("click").on("click",function(o){o.preventDefault();$.post(m+"/api/session.json?callback=?",{},function(p){},"json");setTimeout(function(){window.location.reload(e)},100)})}function h(q,r,o,p){var t=(screen.width/2)-(r/2);var s=(screen.height/2)-(o/2);return window.open(q,p,"menubar=no,toolbar=no,status=no,scrollbars=no,resizable=no,width="+r+",height="+o+",toolbar=no,left="+t+",top="+s)}function c(o){if(environment.hasOwnProperty("login")&&environment.login==false){$("#conn_social").modal("hide");auth_url=encodeURI("/auth/"+o+"?display=popup");auth_window=h(auth_url,600,400,"authPopup");var p=setInterval(function(){if(auth_window.closed){clearInterval(p);var q=true;k(q)}},200)}}function i(o,p,r){var q=$("#frm-content").val();$.post(m+"/api/stories.json?callback=?",{connection:o,content:q,token:getUrlVar("token"),author:p,session:r},function(s){if(s.hasOwnProperty("content")){var t="just now";$("#frm-content").val("");$("#submit").addClass("disabled");if($(".annotation").length>0){b(".annotation",s.content,s.author,t)}else{a(".annotation",s.content,s.author,t)}}},"json").error(function(){j()})}function k(o){$.getJSON(m+"/api/session.json?callback=?",function(p){if(typeof p!=="undefined"&&p.hasOwnProperty("sess")&&p.sess!==false){environment.login=true;$.when($("a.logout").show()).done(function(){n()});$("#conn_social").remove();$("#submit").html("Post");$("div.logout").show();$(".frm-connection").html(p.conn[0].toUpperCase()+p.conn.substring(1));$("#frm-content").on("keyup",function(){$("#submit").removeClass("disabled")});$("#submit.post").off("click").on("click",function(){var t=$("#frm-content").val();if(!t){return false}var s=$("input#frm-anonymous-check:checked");if(s.length==1){var r="Anonymous"}else{var r=p.user}i(p.conn,r,p.sess)})}else{if(typeof o!=="undefined"){environment.login=false;var q=true;j(q)}else{environment.login=false}}})}function a(o,q,p,r){$(prepareStoryHTML(o,q,p,r)).appendTo(".texts")}function b(o,q,p,r){$(prepareStoryHTML(o,q,p,r)).prependTo("div.annotation:first")}function j(p,o){if(typeof p!=="undefined"){$("<div class='post_error'><p>Unable to Log You In.</p>").prependTo("#frm-annotate .buttons");setTimeout(function(){$(".post_error").fadeOut().empty()},5000)}else{if(typeof o!=="undefined"){$("<div class='post_error'><p>Unable to Log You Out</p>").prependTo("#frm-annotate .buttons");setTimeout(function(){$(".post_error").fadeOut().empty()},5000)}else{$("<div class='post_error'><p>Post Unsuccessful. Try Again Later.</p>").prependTo("#frm-annotate .buttons");setTimeout(function(){$(".post_error").fadeOut().empty()},30000)}}}return{init:f,appendStory:a,checkSession:k}};